<div class="popIn-animations shopping-cart-container">
  <!-- Header -->
  <div class="cart-header mb-4">
    <a href="#" class="back-link d-inline-flex align-items-center fw-semibold px-3 py-2 rounded">
      <i class="bi bi-arrow-left me-2"></i>
      Continuar comprando
    </a>
  </div>

  <h6 class="fw-bold text-dark mb-4">Carrito de compras</h6>

  <!-- Wishlist Section -->
  <div class="popIn-animations wishlist-banner card mb-4">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <i class="bi bi-heart text-danger fs-3 me-3"></i>
        <div>
          <h6 class="mb-0">Lista de Deseos</h6>
          <p class="text-muted mb-0 small">Tienes {{ wishlistCount }} artículos guardados para más tarde</p>
        </div>
      </div>
      <div>
        <a routerLink="/wishlist" class="btn btn-link text-primary text-decoration-none me-2">
          Ver Todo
        </a>
        <button (click)="addFavoritesToCart()" class="btn btn-primary">
          <i class="bi bi-cart-fill"></i> Agregar Todo al Carrito
        </button>
      </div>
    </div>
  </div>

  <div class="popIn-animations row g-4">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h6 class="mb-4">Artículos en el Carrito ({{ cartItems.length }})</h6>

          <ng-container *ngIf="cartItems.length > 0; else emptyCart">
            <div class="cart-item" *ngFor="let item of cartItems; let last = last" [class.border-bottom]="!last">
              <div class="row align-items-center">
                <div class="col-md-2 col-3">
                  <a routerLink="/producto/{{ item.producto_id }}">
                    <img [src]="item.imagen ? item.imagen : 'null.png'" class="img-fluid h-100 rounded"
                      [style.object-fit]="'cover'" alt="{{ item.nombre }}">
                  </a>
                </div>

                <div class="col-md-4 col-9">
                  <h6 class="product-name mb-1">{{ item.nombre }}</h6>
                  <p class="product-price mb-0">${{ item.precio| number:'1.0-0':'es-CL' }}</p>
                </div>

                <div class="col-md-3 col-6">
                  <div class="quantity-controls d-flex align-items-center justify-content-center">
                    <button class="btn btn-outline-secondary btn-sm" (click)="decreaseQuantity(item)"
                      [disabled]="item.cantidad <= 1">
                      <i class="bi bi-dash"></i>
                    </button>
                    <span class="quantity-value mx-3">{{ item.cantidad }}</span>
                    <button class="btn btn-outline-secondary btn-sm" (click)="increaseQuantity(item)">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                </div>

                <div class="col-md-3 col-6">
                  <div class="text-end">
                    <h5 class="item-total mb-3">${{ item.cantidad * item.precio| number:'1.0-0':'es-CL' }}</h5>
                    <div class="item-actions">
                      <button class="btn btn-link text-secondary p-1" (click)="addToWishlist(item)"
                        title="Agregar a lista de deseos">
                        <i class="bi fs-5" [ngClass]="{
                            'bi-heart-fill text-danger': isFavorite(item.producto_id),
                            'bi-heart text-secondary': !isFavorite(item.producto_id)
                        }">
                        </i>
                      </button>
                      <button class="btn btn-link text-danger p-1" (click)="removeItem(item)" title="Eliminar artículo">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-template #emptyCart>
            <div class="p-5 text-center text-muted">
              Tu carrito de compras está vacío.
            </div>
          </ng-template>

        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card order-summary-card sticky-top">
        <div class="card-body">
          <h4 class="mb-4">Resumen del Pedido</h4>

          <div class="summary-row d-flex justify-content-between mb-3">
            <span class="text-muted">Subtotal</span>
            <span class="fw-bold">${{ subtotal | number:'1.0-0':'es-CL'}}</span>
          </div>

          <div class="summary-row d-flex justify-content-between mb-3">
            <span class="text-muted">
              <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-html="true"
                title="Este cargo corresponde al armado<br>- Organización de tu pedido<br>- Empaquetado de útiles">
              </i>

              Cargo por armado
            </span>
            <span class="fw-bold">${{ tax | number:'1.0-0':'es-CL' }}</span>
          </div>

          <hr>

          <div class="summary-row d-flex justify-content-between mb-4">
            <span class="fs-5 fw-bold">Total</span>
            <span class="fs-5 fw-bold">${{ total | number:'1.0-0':'es-CL' }}</span>
          </div>

          <div class="mt-2">
            <label class="form-label d-flex align-items-center gap-2 border rounded px-3 py-2 cursor-pointer">
              <i class="bi bi-paperclip"></i>
              <span>Subir comprobante imagen o pdf</span>
              <input type="file" accept=".pdf,image/*" hidden (change)="onFileSelected($event)">
            </label>

            <!-- Mostrar nombre del archivo si existe -->
            <div *ngIf="fileName" class="mt-1 text-muted small">
              Archivo seleccionado: {{ fileName }}
            </div>
          </div>

          <div class="mt-3 p-3 border rounded bg-light text-dark small">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-info-circle text-primary fs-5 mt-1"></i>
              <div>
                <strong>Importante:</strong> Este comprobante corresponde al
                <span class="fw-semibold">cargo por armado del pedido escolar</span>,
                el cual tiene un valor de <span class="fw-semibold">$5.000</span>.
                <br>
                Este monto debe ser depositado en la siguiente cuenta:
                <ul class="mb-2 mt-2">
                  <li><strong>Banco:</strong> Banco de Chile</li>
                  <li><strong>Cuenta Corriente:</strong> 123456789</li>
                  <li><strong>Nombre:</strong> Importadora Paola</li>
                  <li><strong>RUT:</strong> 76.123.456-7</li>
                  <li><strong>Correo:</strong> pagos&#64;importadoraPaola.cl</li>
                </ul>
                El resto del total del pedido se pagará <span class="fw-semibold">en caja de forma presencial</span>
                antes del retiro.
              </div>
            </div>
          </div>

          <div class="mt-4">
            <button class="btn btn-primary w-100 btn-lg" [disabled]="cartItems.length === 0 || processingOrder"
              (click)="processOrder()">
              <i *ngIf="processingOrder" class="bi bi-arrow-clockwise spin"></i>
              Procesar orden
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación de compra -->
<div class="modal fade" id="compraExitosaModal" tabindex="-1" aria-labelledby="compraExitosaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="compraExitosaLabel">¡Compra realizada con éxito!</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-dark">
        <p class="mb-2">
          Gracias por confiar en <strong>Importadora Paola</strong>. Tu pedido ha sido procesado correctamente.
        </p>
        <p class="mb-2">
          En breve recibirás un correo con el <strong>detalle completo de tu compra</strong>.
        </p>
        <p class="mb-0">
          Además, podrás revisar el <strong>estado de tu pedido</strong> en la sección <span class="text-primary">Mis
            Pedidos</span> dentro de tu cuenta.
        </p>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>
